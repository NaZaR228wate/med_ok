<!doctype html>
<html lang="uk">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Оформлення замовлення — med_ok</title>
    <link rel="stylesheet" href="styles.css" />
</head>
<body>
<!-- ===== HEADER ===== -->
<header>
    <div class="container nav">
        <a href="index.html" class="brand" aria-label="На головну">
            <!-- іконка може бути будь-яка; лишив простий емодзі -->
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <circle cx="12" cy="12" r="10" stroke-width="2"/>
                <circle cx="12" cy="12" r="6" stroke-width="2"/>
            </svg>
            <span>med_ok</span>
        </a>

        <nav class="nav">
            <a href="index.html">Продукція</a>
            <a href="index.html#why">Про пасіку</a>
            <a href="index.html#why">Чому ми</a>
            <a href="order.html" class="cta">Замовити</a>
        </nav>
    </div>
</header>

<!-- ===== PAGE ===== -->
<main class="container">
    <h1 class="section-title">Оформлення замовлення</h1>
    <p class="muted" style="margin-top:-6px; margin-bottom:14px">
        Заповніть форму. Поля зі * — обов’язкові.
    </p>

    <!-- ВАЖЛИВО: id="order" (так очікує твій CSS) -->
    <form id="order" class="card">
        <!-- Ім'я / Телефон -->
        <div class="grid">
            <div class="col-6">
                <label for="name">Ім’я *</label>
                <input id="name" type="text" placeholder="Ваше ім’я" required />
            </div>
            <div class="col-6">
                <label for="phone">Телефон *</label>
                <input id="phone" type="tel" placeholder="+380..." required />
            </div>
        </div>

        <!-- Вид меду / Кількість -->
        <div class="grid">
            <div class="col-6">
                <label for="honey">Вид меду *</label>
                <select id="honey" required>
                    <option>Акацієвий</option>
                    <option>Липовий</option>
                    <option>Соняшниковий</option>
                    <option>Різнотрав'я</option>
                </select>
            </div>
            <div class="col-6">
                <label for="qty">Кількість (л) *</label>
                <select id="qty" required>
                    <option value="0.5">0.5</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="5">5</option>
                </select>

            </div>
        </div>

        <!-- Підсумок (виглядає як у тебе завдяки .summary) -->
        <div class="summary">
            <div class="summary-row">
                <span class="muted">Ефективна ціна за 1 л</span>
                <b id="effPrice">—</b>
            </div>
            <div class="summary-row">
                <span class="muted">Коефіцієнт</span>
                <b id="coef">—</b>
            </div>
            <div class="summary-row total">
                <span>До сплати</span>
                <b id="total">—</b>
            </div>
        </div>

        <!-- Доставка -->
        <h2 class="section-subtitle">Доставка</h2>
        <div class="grid">
            <div class="col-12">
                <label for="ship">Спосіб доставки *</label>
                <select id="ship" required>
                    <option value="np_branch">Нова пошта — відділення</option>
                </select>
            </div>
        </div>

        <!-- Оплата + сума в оплаті -->
        <div class="grid">
            <div class="col-12">
                <label>Оплата *</label>
                <div class="radios" style="display:flex; gap:22px; align-items:center;">
                    <label><input type="radio" name="pay" value="cod" checked> Накладений платіж</label>
                    <label><input type="radio" name="pay" value="prepay"> Повна передоплата</label>
                </div>
                <!-- суму стилізуємо твоїм блоком .summary -->
                <div class="summary" style="margin-top:10px">
                    <div class="summary-row total">
                        <span>Сума до сплати</span>
                        <b id="payTotal">—</b>
                    </div>
                </div>
            </div>
        </div>

        <!-- Нова пошта -->
        <div class="grid">
            <div class="col-12">
                <label for="citySearch">Пошук міста (2+ літери)</label>
                <input id="citySearch" type="text" placeholder="Почніть вводити назву… (напр., Ки)" />
            </div>

            <div class="col-12">
                <label for="city">Місто (Нова пошта) *</label>
                <select id="city" required disabled>
                    <option value="">Спочатку введіть 2+ літери у полі вище…</option>
                </select>
            </div>

            <div class="col-12">
                <label for="warehouse">Відділення (№/адреса) *</label>
                <select id="warehouse" required disabled>
                    <option value="">Спочатку оберіть місто</option>
                </select>
                <div id="wh-status" class="muted" style="margin-top:6px"></div>
            </div>
        </div>

        <!-- Коментар -->
        <div class="grid">
            <div class="col-12">
                <label for="comment">Коментар</label>
                <textarea id="comment" placeholder="Зручний час дзвінка, деталі замовлення тощо"></textarea>
            </div>
        </div>

        <div class="actions">
            <button class="btn" type="submit">Надіслати замовлення</button>
        </div>
    </form>
</main>

<footer class="container" style="padding-top:0">
    <div class="muted" style="border-top:1px solid #eee; padding-top:14px">
        © med_ok — Доставка по Україні (Нова пошта)
    </div>
</footer>

<!-- ===== КОНФІГ API ===== -->
<script>
    const WORKER_BASE = 'https://medok-proxy.veter010709.workers.dev';
    const ORDER_EMAIL = 'veter010709@gmail.com';
</script>

<!-- ===== ЛОГІКА (API + калькулятор) ===== -->
<script>
    // Елементи (ID узгоджені з твоїм CSS)
    const form       = document.getElementById('order');
    const nameI      = document.getElementById('name');
    const phoneI     = document.getElementById('phone');
    const honeySel   = document.getElementById('honey');
    const qtySel     = document.getElementById('qty');
    const shipSel    = document.getElementById('ship');
    const citySearch = document.getElementById('citySearch');
    const citySel    = document.getElementById('city');
    const whSel      = document.getElementById('warehouse');
    const whStatus   = document.getElementById('wh-status');
    const commentI   = document.getElementById('comment');

    const effPriceEl = document.getElementById('effPrice');
    const coefEl     = document.getElementById('coef');
    const totalEl    = document.getElementById('total');
    const payTotalEl = document.getElementById('payTotal');

    // Ціни / знижки
    const BASE_PRICE = {
        "Акацієвий": 300,
        "Липовий": 250,
        "Соняшниковий": 200,
        "Різнотрав'я": 220
    };
    // Заміни свою coefForQty на цю
    function coefForQty(q){
        q = Number(q || 1);

        // 0.5 л — дорожче на 20%
        if (q === 0.5) return 1.20;

        // знижки за обсяг
        if (q >= 5)  return 0.90;
        if (q >= 2)  return 0.95;

        // 1 л — без змін
        return 1.00;
    }

    const fmtUAH = x => new Intl.NumberFormat('uk-UA').format(Math.round(x)) + ' грн';

    function recalc(){
        const h = honeySel.value;
        const q = Number(qtySel.value || 1);
        const base = BASE_PRICE[h] ?? 0;
        const k = coefForQty(q);
        const eff = base * k;
        const sum = eff * q;

        effPriceEl.textContent = base ? fmtUAH(eff) : '—';
        coefEl.textContent     = base ? (k.toFixed(2)+'×') : '—';
        totalEl.textContent    = base ? fmtUAH(sum) : '—';
        payTotalEl.textContent = base ? fmtUAH(sum) : '—';
    }

    // helpers
    function debounce(fn, ms=350){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
    async function getJSON(url){
        const r = await fetch(url, { method:'GET' });
        if (!r.ok) throw new Error('HTTP '+r.status);
        return r.json();
    }

    // Префіл з URL (honey, qty)
    (()=>{ try{
        const u = new URL(location.href);
        const h = u.searchParams.get('honey');
        const q = u.searchParams.get('qty');
        if (h) { for (const o of [...honeySel.options]) if (o.value===h) honeySel.value=h; }
        if (q) { qtySel.value = q; }
    }catch{} })();

    // Пошук міст (без автоселекту)
    async function searchCities(){
        const q = citySearch.value.trim();
        if (q.length < 2) return;

        try{
            const data = await getJSON(`${WORKER_BASE}/np/cities?q=${encodeURIComponent(q)}`);
            const list = Array.isArray(data?.data) ? data.data : [];

            citySel.innerHTML = '';
            const ph = document.createElement('option');
            ph.value=''; ph.textContent='Оберіть місто зі списку…';
            ph.selected = true; ph.disabled = true;
            citySel.appendChild(ph);

            for (const c of list){
                const opt = document.createElement('option');
                opt.value = c.Ref || c.CityRef || '';
                const name = c.Description || c.DescriptionRu || c.Present || '';
                const area = c.AreaDescription || '';
                opt.textContent = area ? `${name} (${area})` : name;
                opt.dataset.cityName = name;
                citySel.appendChild(opt);
            }
            citySel.disabled = citySel.options.length <= 1;
        }catch(e){
            console.error('cities error', e);
            citySel.innerHTML = '';
            const err = document.createElement('option');
            err.value=''; err.textContent='Помилка завантаження';
            err.selected=true; err.disabled=true;
            citySel.appendChild(err);
            citySel.disabled = true;
        }
    }
    citySearch.addEventListener('input', debounce(searchCities, 350));

    // Відділення
    async function loadWarehouses(){
        const ref = citySel.value;
        if (!ref){
            whSel.innerHTML = `<option value="">Спочатку оберіть місто</option>`;
            whSel.disabled = true; whStatus.textContent = '';
            return;
        }
        whStatus.textContent = 'Завантажуємо відділення…';
        whSel.innerHTML = `<option value="">Завантаження…</option>`;
        whSel.disabled = true;

        try{
            const data = await getJSON(`${WORKER_BASE}/np/warehouses?cityRef=${encodeURIComponent(ref)}`);
            const list = Array.isArray(data?.data) ? data.data : [];
            whSel.innerHTML = '';
            for (const w of list){
                const num  = w.Number || '';
                const addr = w.ShortAddress || w.Description || '';
                const text = num ? `Відділення №${num}, ${addr}` : addr;
                const opt  = document.createElement('option');
                opt.value = text; opt.textContent = text;
                whSel.appendChild(opt);
            }
            whSel.disabled = !list.length;
            whStatus.textContent = list.length ? '' : 'Немає відділень';
        }catch(e){
            console.error('warehouses error', e);
            whSel.innerHTML = `<option value="">Помилка завантаження</option>`;
            whSel.disabled = true;
            whStatus.textContent = 'Помилка завантаження';
        }
    }
    citySel.addEventListener('change', loadWarehouses);

    // Надсилання
    form.addEventListener('submit', async (ev)=>{
        ev.preventDefault();
        const pay = (form.querySelector('input[name="pay"]:checked')||{}).value || 'cod';

        const payload = {
            name: nameI.value.trim(),
            phone: phoneI.value.trim(),
            honey: honeySel.value,
            qty: qtySel.value,
            pay,
            ship: shipSel.value,
            np_city: citySel.options[citySel.selectedIndex]?.dataset?.cityName || '',
            np_warehouse: whSel.value || '',
            comment: commentI.value.trim(),
            email: ORDER_EMAIL
        };

        if (!payload.name || !payload.phone || !payload.np_city || !payload.np_warehouse){
            alert('Будь ласка, заповніть усі обовʼязкові поля.');
            return;
        }

        try{
            const r = await fetch(`${WORKER_BASE}/order`, {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify(payload)
            });
            const data = await r.json();
            if (data?.ok){
                alert('Замовлення надіслано! Ми звʼяжемося з вами найближчим часом.');
                form.reset();
                effPriceEl.textContent = '—';
                coefEl.textContent = '—';
                totalEl.textContent = '—';
                payTotalEl.textContent = '—';
                citySel.innerHTML = `<option value="">Спочатку введіть 2+ літери у полі вище…</option>`;
                citySel.disabled = true;
                whSel.innerHTML = `<option value="">Спочатку оберіть місто</option>`;
                whSel.disabled = true;
                whStatus.textContent = '';
            }else{
                throw new Error(data?.error || 'Unknown');
            }
        }catch(e){
            console.error('order error', e);
            alert('Не вдалося надіслати замовлення. Спробуйте ще раз, будь ласка.');
        }
    });

    // init
    honeySel.addEventListener('change', recalc);
    qtySel.addEventListener('change', recalc);
    recalc();
</script>
</body>
</html>
