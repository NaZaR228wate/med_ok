<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–û—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è ‚Äî med_ok</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <!-- –®–∞–ø–∫–∞ -->
  <header class="site-header">
    <div class="wrap">
      <a href="index.html" class="logo" aria-label="–ù–∞ –≥–æ–ª–æ–≤–Ω—É">üçØ <span>med_ok</span></a>
      <nav class="nav">
        <a href="index.html">–ù–∞ –≥–æ–ª–æ–≤–Ω—É</a>
      </nav>
    </div>
  </header>

  <main class="wrap">
    <h1 class="section-title">–û—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</h1>

    <form id="orderForm" class="form">
      <!-- –ü–Ü–ë / —Ç–µ–ª–µ—Ñ–æ–Ω -->
      <div class="grid-2">
        <div class="form-group">
          <label for="name">–í–∞—à–µ —ñ–º º—è *</label>
          <input id="name" type="text" required placeholder="–Ü–º º—è —Ç–∞ –ø—Ä—ñ–∑–≤–∏—â–µ" />
        </div>
        <div class="form-group">
          <label for="phone">–¢–µ–ª–µ—Ñ–æ–Ω *</label>
          <input id="phone" type="tel" required placeholder="+380..." />
        </div>
      </div>

      <!-- –ú–µ–¥ / –∫—ñ–ª—å–∫—ñ—Å—Ç—å -->
      <div class="grid-3">
        <div class="form-group">
          <label for="honey">–í–∏–¥ –º–µ–¥—É *</label>
          <select id="honey" required>
            <option>–ê–∫–∞—Ü—ñ—î–≤–∏–π</option>
            <option>–õ–∏–ø–æ–≤–∏–π</option>
            <option>–°–æ–Ω—è—à–Ω–∏–∫–æ–≤–∏–π</option>
            <option>–†—ñ–∑–Ω–æ—Ç—Ä–∞–≤'—è</option>
          </select>
        </div>

        <div class="form-group">
          <label for="qty">–ö—ñ–ª—å–∫—ñ—Å—Ç—å (–ª) *</label>
          <select id="qty" required>
            <option>1</option>
            <option>2</option>
            <option>3</option>
            <option>5</option>
            <option>10</option>
          </select>
        </div>

        <div class="form-group">
          <label>–í–∏–¥/–æ–±‚Äô—î–º</label>
          <div class="muted">‚Äî</div>
        </div>
      </div>

      <!-- –ü—ñ–¥—Å—É–º–æ–∫ -->
      <div class="calc">
        <div><span class="muted">–ï—Ñ–µ–∫—Ç–∏–≤–Ω–∞ —Ü—ñ–Ω–∞ –∑–∞ 1 –ª</span><b id="effPrice">‚Äî</b></div>
        <div><span class="muted">–ö–æ–µ—Ñ—ñ—Ü—ñ—î–Ω—Ç</span><b id="coef">‚Äî</b></div>
        <div class="total"><span>–î–æ —Å–ø–ª–∞—Ç–∏</span><b id="total">‚Äî</b></div>
      </div>

      <!-- –î–æ—Å—Ç–∞–≤–∫–∞ -->
      <h2 class="section-subtitle">–î–æ—Å—Ç–∞–≤–∫–∞</h2>

      <div class="form-group">
        <label for="ship">–°–ø–æ—Å—ñ–± –¥–æ—Å—Ç–∞–≤–∫–∏ *</label>
        <select id="ship" required>
          <option value="np_branch">–ù–æ–≤–∞ –ø–æ—à—Ç–∞ ‚Äî –≤—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è</option>
        </select>
      </div>

      <!-- –û–ø–ª–∞—Ç–∞ -->
      <div class="form-group">
        <label>–û–ø–ª–∞—Ç–∞ *</label>
        <div class="radios">
          <label><input type="radio" name="pay" value="cod" checked /> –ù–∞–∫–ª–∞–¥–µ–Ω–∏–π –ø–ª–∞—Ç—ñ–∂</label>
          <label><input type="radio" name="pay" value="prepay" /> –ü–æ–≤–Ω–∞ –ø–µ—Ä–µ–¥–æ–ø–ª–∞—Ç–∞</label>
        </div>
        <div id="payTotal" class="muted" style="margin-top:.5rem;"></div>
      </div>

      <!-- –ù–æ–≤–∞ –ø–æ—à—Ç–∞ -->
      <div class="grid-2">
        <div class="form-group">
          <label for="citySearch">–ü–æ—à—É–∫ –º—ñ—Å—Ç–∞ (2+ –ª—ñ—Ç–µ—Ä–∏)</label>
          <input id="citySearch" type="text" placeholder="–ü–æ—á–Ω—ñ—Ç—å –≤–≤–æ–¥–∏—Ç–∏ –Ω–∞–∑–≤—É‚Ä¶ (–Ω–∞–ø—Ä., –ö–∏)" />
        </div>
        <div class="form-group">
          <label for="city">–ú—ñ—Å—Ç–æ (–ù–æ–≤–∞ –ø–æ—à—Ç–∞) *</label>
          <select id="city" required disabled>
            <option value="">–°–ø–æ—á–∞—Ç–∫—É –≤–≤–µ–¥—ñ—Ç—å 2+ –ª—ñ—Ç–µ—Ä–∏ —É –ø–æ–ª—ñ –≤–∏—â–µ‚Ä¶</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label for="warehouse">–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è (‚Ññ/–∞–¥—Ä–µ—Å–∞) *</label>
        <select id="warehouse" required disabled>
          <option value="">–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å –º—ñ—Å—Ç–æ</option>
        </select>
        <div id="wh-status" class="muted" style="margin-top:.25rem;"></div>
      </div>

      <!-- –ö–æ–º–µ–Ω—Ç–∞—Ä -->
      <div class="form-group">
        <label for="comment">–ö–æ–º–µ–Ω—Ç–∞—Ä</label>
        <textarea id="comment" rows="3" placeholder="–ó—Ä—É—á–Ω–∏–π —á–∞—Å –¥–∑–≤—ñ–Ω–∫–∞, –¥–µ—Ç–∞–ª—ñ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è —Ç–æ—â–æ"></textarea>
      </div>

      <div class="actions">
        <button type="submit" class="btn btn-primary">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</button>
      </div>
    </form>
  </main>

  <footer class="site-footer">
    <div class="wrap footer-inner">
      <div>¬© med_ok</div>
      <div class="muted">–î–æ—Å—Ç–∞–≤–∫–∞ –ø–æ –£–∫—Ä–∞—ó–Ω—ñ ‚Äî –ù–æ–≤–∞ –ø–æ—à—Ç–∞</div>
    </div>
  </footer>

  <!-- ===== –ö–û–ù–§–Ü–ì API ===== -->
  <script>
    const WORKER_BASE = 'https://medok-proxy.veter010709.workers.dev';
    const ORDER_EMAIL = 'veter010709@gmail.com';
  </script>

  <!-- ===== –°–ö–†–ò–ü–¢ (API + –ª–æ–≥—ñ–∫–∞) ===== -->
  <script>
    // –ï–ª–µ–º–µ–Ω—Ç–∏
    const form       = document.getElementById('orderForm');
    const nameI      = document.getElementById('name');
    const phoneI     = document.getElementById('phone');
    const honeySel   = document.getElementById('honey');
    const qtySel     = document.getElementById('qty');
    const shipSel    = document.getElementById('ship');
    const citySearch = document.getElementById('citySearch');
    const citySel    = document.getElementById('city');
    const whSel      = document.getElementById('warehouse');
    const whStatus   = document.getElementById('wh-status');
    const commentI   = document.getElementById('comment');

    const effPriceEl = document.getElementById('effPrice');
    const coefEl     = document.getElementById('coef');
    const totalEl    = document.getElementById('total');
    const payTotalEl = document.getElementById('payTotal');

    // –¶—ñ–Ω–∏ / –∑–Ω–∏–∂–∫–∏
    const BASE_PRICE = {
      "–ê–∫–∞—Ü—ñ—î–≤–∏–π": 300,
      "–õ–∏–ø–æ–≤–∏–π": 250,
      "–°–æ–Ω—è—à–Ω–∏–∫–æ–≤–∏–π": 200,
      "–†—ñ–∑–Ω–æ—Ç—Ä–∞–≤'—è": 220
    };
    function coefForQty(q){
      q = Number(q||1);
      if (q >= 10) return 0.85;
      if (q >= 5)  return 0.90;
      if (q >= 2)  return 0.95;
      return 1.00;
    }
    const fmtUAH = (x)=> new Intl.NumberFormat('uk-UA')
        .format(Math.round(x)) + ' –≥—Ä–Ω';

    function recalc(){
      const h = honeySel.value;
      const q = Number(qtySel.value || 1);
      const base = BASE_PRICE[h] ?? 0;
      const k = coefForQty(q);
      const eff = base * k;
      const sum = eff * q;

      effPriceEl.textContent = base ? fmtUAH(eff) : '‚Äî';
      coefEl.textContent     = base ? (k.toFixed(2)+'√ó') : '‚Äî';
      totalEl.textContent    = base ? fmtUAH(sum) : '‚Äî';
      payTotalEl.textContent = '–°—É–º–∞ –¥–æ —Å–ø–ª–∞—Ç–∏: ' + (base ? fmtUAH(sum) : '‚Äî');
    }

    // –£—Ç–∏–ª—ñ—Ç–∏
    function debounce(fn, ms=350){
      let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); };
    }
    async function getJSON(url){
      const r = await fetch(url, { method:'GET' });
      if (!r.ok) throw new Error('HTTP '+r.status);
      return r.json();
    }

    // –ü—Ä–µ—Ñ—ñ–ª –∑ URL
    (function prefillFromQuery(){
      try{
        const u = new URL(location.href);
        const h = u.searchParams.get('honey');
        const q = u.searchParams.get('qty');
        if (h) { for (const o of [...honeySel.options]) if (o.value===h) honeySel.value=h; }
        if (q) { qtySel.value = q; }
      }catch{}
    })();

    // –ü–æ—à—É–∫ –º—ñ—Å—Ç (–ù–ï –∞–≤—Ç–æ—Å–µ–ª–µ–∫—Ç–∏–º–æ –ø–µ—Ä—à–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç)
    async function searchCities(){
      const q = citySearch.value.trim();
      if (q.length < 2) return;

      try{
        const data = await getJSON(`${WORKER_BASE}/np/cities?q=${encodeURIComponent(q)}`);
        const list = Array.isArray(data?.data) ? data.data : [];

        citySel.innerHTML = '';
        const ph = document.createElement('option');
        ph.value=''; ph.textContent='–û–±–µ—Ä—ñ—Ç—å –º—ñ—Å—Ç–æ –∑—ñ —Å–ø–∏—Å–∫—É‚Ä¶';
        ph.selected = true; ph.disabled = true;
        citySel.appendChild(ph);

        for (const c of list){
          const opt = document.createElement('option');
          opt.value = c.Ref || c.CityRef || '';
          const name = c.Description || c.DescriptionRu || c.Present || '';
          const area = c.AreaDescription || '';
          opt.textContent = area ? `${name} (${area})` : name;
          opt.dataset.cityName = name;
          citySel.appendChild(opt);
        }

        citySel.disabled = citySel.options.length <= 1;
        // –ù–µ –≤–∏–∫–ª–∏–∫–∞—î–º–æ loadWarehouses —Ç—É—Ç ‚Äî —á–µ–∫–∞—î–º–æ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –≤–∏–±–æ—Ä—É (change)
      }catch(e){
        console.error('cities error', e);
        citySel.innerHTML = '';
        const err = document.createElement('option');
        err.value=''; err.textContent='–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è';
        err.selected=true; err.disabled=true;
        citySel.appendChild(err);
        citySel.disabled = true;
      }
    }
    citySearch.addEventListener('input', debounce(searchCities, 350));

    // –í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è
    async function loadWarehouses(){
      const ref = citySel.value;
      if (!ref){
        whSel.innerHTML = `<option value="">–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å –º—ñ—Å—Ç–æ</option>`;
        whSel.disabled = true;
        whStatus.textContent = '';
        return;
      }
      whStatus.textContent = '–ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –≤—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è‚Ä¶';
      whSel.innerHTML = `<option value="">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶</option>`;
      whSel.disabled = true;

      try{
        const data = await getJSON(`${WORKER_BASE}/np/warehouses?cityRef=${encodeURIComponent(ref)}`);
        const list = Array.isArray(data?.data) ? data.data : [];
        whSel.innerHTML = '';
        for (const w of list){
          const num  = w.Number || '';
          const addr = w.ShortAddress || w.Description || '';
          const text = num ? `–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è ‚Ññ${num}, ${addr}` : addr;
          const opt  = document.createElement('option');
          opt.value = text;
          opt.textContent = text;
          whSel.appendChild(opt);
        }
        whSel.disabled = !list.length;
        whStatus.textContent = list.length ? '' : '–ù–µ–º–∞—î –≤—ñ–¥–¥—ñ–ª–µ–Ω—å';
      }catch(e){
        console.error('warehouses error', e);
        whSel.innerHTML = `<option value="">–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è</option>`;
        whSel.disabled = true;
        whStatus.textContent = '–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è';
      }
    }
    citySel.addEventListener('change', loadWarehouses);

    // –í—ñ–¥–ø—Ä–∞–≤–∫–∞
    form.addEventListener('submit', async (ev)=>{
      ev.preventDefault();
      const pay = (form.querySelector('input[name="pay"]:checked')||{}).value || 'cod';

      const payload = {
        name: nameI.value.trim(),
        phone: phoneI.value.trim(),
        honey: honeySel.value,
        qty: qtySel.value,
        pay,
        ship: shipSel.value,
        np_city: citySel.options[citySel.selectedIndex]?.dataset?.cityName || '',
        np_warehouse: whSel.value || '',
        comment: commentI.value.trim(),
        email: ORDER_EMAIL
      };

      if (!payload.name || !payload.phone || !payload.np_city || !payload.np_warehouse){
        alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø–æ–≤–Ω—ñ—Ç—å —É—Å—ñ –æ–±–æ–≤ º—è–∑–∫–æ–≤—ñ –ø–æ–ª—è.');
        return;
      }

      try{
        const r = await fetch(`${WORKER_BASE}/order`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        const data = await r.json();
        if (data?.ok){
          alert('–ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ! –ú–∏ –∑–≤ º—è–∂–µ–º–æ—Å—è –∑ –≤–∞–º–∏ –Ω–∞–π–±–ª–∏–∂—á–∏–º —á–∞—Å–æ–º.');
          form.reset();
          effPriceEl.textContent = '‚Äî';
          coefEl.textContent = '‚Äî';
          totalEl.textContent = '‚Äî';
          payTotalEl.textContent = '–°—É–º–∞ –¥–æ —Å–ø–ª–∞—Ç–∏: ‚Äî';
          citySel.innerHTML = `<option value="">–°–ø–æ—á–∞—Ç–∫—É –≤–≤–µ–¥—ñ—Ç—å 2+ –ª—ñ—Ç–µ—Ä–∏ —É –ø–æ–ª—ñ –≤–∏—â–µ‚Ä¶</option>`;
          citySel.disabled = true;
          whSel.innerHTML = `<option value="">–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å –º—ñ—Å—Ç–æ</option>`;
          whSel.disabled = true;
          whStatus.textContent = '';
        }else{
          throw new Error(data?.error || 'Unknown');
        }
      }catch(e){
        console.error('order error', e);
        alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑, –±—É–¥—å –ª–∞—Å–∫–∞.');
      }
    });

    // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è
    honeySel.addEventListener('change', recalc);
    qtySel.addEventListener('change', recalc);
    recalc();
  </script>
</body>
</html>
