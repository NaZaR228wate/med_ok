<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Оформлення замовлення — med_ok</title>

  <!-- твій спільний стиль -->
  <link rel="stylesheet" href="styles.css?v=6"/>

  <!-- невеликий “страхувальний” стиль, якщо чогось бракує у styles.css -->
  <style>
    body{background:#f9f7f1;color:#222;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif}
    .container{max-width:1080px;margin:0 auto;padding:24px}
    header{position:sticky;top:0;background:#fffdf8;border-bottom:1px solid #eee;z-index:50}
    .nav{display:flex;align-items:center;gap:16px;height:56px}
    .brand{display:flex;align-items:center;gap:8px;text-decoration:none;color:#111;font-weight:700}
    .brand svg{width:22px;height:22px}
    .nav-right{margin-left:auto;display:flex;align-items:center;gap:20px}
    .nav-right a{color:#111;text-decoration:none;font-weight:500}
    .cta, .btn{display:inline-block;background:#0b7a05;color:#fff;border-radius:28px;padding:10px 18px;font-weight:700;text-decoration:none;border:none;cursor:pointer}
    h1{font-size:32px;margin:24px 0 12px}
    .card{background:#fff;border:1px solid #eee;border-radius:16px;box-shadow:0 2px 10px rgba(0,0,0,.04)}
    form .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    form .row-1{grid-template-columns:1fr 1fr}
    form .col{display:flex;flex-direction:column;gap:6px}
    label{font-size:14px;color:#333}
    input,select,textarea{border:1px solid #ddd;border-radius:10px;padding:12px 12px;font:inherit;background:#fff}
    textarea{min-height:96px;resize:vertical}
    .note{font-size:12px;color:#777}
    .note.warn{color:#a36500}
    .note.error{color:#b00020}
    .actions{display:flex;justify-content:center;padding-top:12px}
    .muted{color:#777;font-size:12px}
    .mt-8{margin-top:8px}
    .mt-16{margin-top:16px}
    .hidden{display:none}
    @media (max-width:900px){ .nav-right{display:none} } /* на мобілці залишається твоє бургер-меню з index */
  </style>
</head>
<body>

<!-- ХЕДЕР як на index -->
<header>
  <div class="container nav">
    <a class="brand" href="index.html" aria-label="На головну">
      <svg viewBox="0 0 64 64" aria-hidden="true" focusable="false">
        <path fill="#f4b400" d="M22 10h20l10 12v20l-10 12H22L12 42V22z"/>
        <path fill="#fff" opacity=".6" d="M26 18h12l6 7v14l-6 7H26l-6-7V25z"/>
      </svg>
      <span>med_ok</span>
    </a>
    <nav class="nav-right" aria-label="Головна навігація">
      <a href="index.html#products">Продукція</a>
      <a href="index.html#about">Про пасіку</a>
      <a href="index.html#why">Чому ми</a>
      <a class="cta" href="order.html">Замовити</a>
    </nav>
  </div>
</header>

<main class="container">
  <h1>Оформлення замовлення</h1>
  <p class="muted">Заповніть форму. Поля зі <strong>*</strong> — обов’язкові. Після натискання «Надіслати» відкриється поштовий клієнт із заповненим листом.</p>

  <section class="card" style="padding:18px 18px 6px" id="order">
    <form id="orderForm" novalidate>
      <!-- Імʼя / Телефон -->
      <div class="row row-1">
        <div class="col">
          <label for="name">Імʼя *</label>
          <input id="name" name="name" placeholder="Ваше імʼя" required />
        </div>
        <div class="col">
          <label for="phone">Телефон *</label>
          <input id="phone" name="phone" placeholder="+380…" inputmode="tel"
                 maxlength="13" pattern="^\+380\d{9}$" title="+380XXXXXXXXX" required />
        </div>
      </div>

      <!-- Вид меду / Кількість -->
      <div class="row mt-16">
        <div class="col">
          <label for="honey">Вид меду *</label>
          <select id="honey" name="honey" required>
            <option value="Акація">Акація</option>
            <option value="Липовий">Липовий</option>
            <option value="Соняшниковий">Соняшниковий</option>
          </select>
        </div>
        <div class="col">
          <label for="qty">Кількість (л) *</label>
          <select id="qty" name="qty" required>
            <option value="0.5">0.5 л</option>
            <option value="1">1 л</option>
            <option value="2">2 л</option>
            <option value="3">3 л</option>
            <option value="5">5 л</option>
          </select>
        </div>
      </div>

      <!-- Доставка / Оплата -->
      <div class="row mt-16">
        <div class="col">
          <label for="ship">Спосіб доставки *</label>
          <select id="ship" name="ship" required>
            <option value="np_branch" selected>Нова пошта — відділення</option>
            <option value="np_courier">Нова пошта — курʼєр</option>
            <option value="pickup">Самовивіз</option>
          </select>
        </div>
        <div class="col">
          <label>Оплата *</label>
          <div style="display:flex;gap:16px;align-items:center;padding:10px 0">
            <label><input type="radio" name="pay" value="cod" checked> Накладений платіж</label>
            <label><input type="radio" name="pay" value="prepay"> Повна передоплата</label>
          </div>
        </div>
      </div>

      <!-- Нова пошта: пошук міста + селект міста (Ref) + відділення -->
      <div id="np-row" class="row mt-16">
        <div class="col">
          <label for="citySearch">Пошук міста (2+ літери)</label>
          <input id="citySearch" placeholder="Почніть вводити назву… (напр., Ки)" autocomplete="off"/>

          <label for="city" class="mt-8">Місто (Нова пошта) *</label>
          <select id="city" required>
            <option value="">Спочатку введіть 2+ літери у полі вище…</option>
          </select>
        </div>
        <div class="col">
          <label for="warehouse">Відділення (№/адреса) *</label>
          <select id="warehouse" disabled required>
            <option>Спочатку оберіть місто</option>
          </select>
          <div id="wh-status" class="note mt-8"></div>
        </div>
      </div>

      <!-- Коментар -->
      <div class="row mt-16">
        <div class="col" style="grid-column:1/-1">
          <label for="comment">Коментар</label>
          <textarea id="comment" name="comment" placeholder="Зручний час дзвінка, деталі замовлення тощо"></textarea>
        </div>
      </div>

      <div class="actions mt-16">
        <button type="submit" class="btn">Надіслати</button>
      </div>

      <p class="muted mt-16" style="text-align:center">
        Якщо обрано «повна передоплата», ми надішлемо реквізити після підтвердження.
      </p>
    </form>
  </section>

  <p class="mt-16"><a href="index.html">← На головну</a></p>
</main>

<script>
  // ===== КОНФІГ =====
  const WORKER_BASE = 'https://medok-proxy.veter010709.workers.dev';
  const ORDER_EMAIL = 'orders@example.com'; // заміни на свій email

  // ===== DOM =====
  const form      = document.getElementById('orderForm');
  const nameI     = document.getElementById('name');
  const phoneI    = document.getElementById('phone');
  const honeySel  = document.getElementById('honey');
  const qtySel    = document.getElementById('qty');
  const shipSel   = document.getElementById('ship');
  const citySearch= document.getElementById('citySearch');
  const citySel   = document.getElementById('city');      // value = Ref
  const whSel     = document.getElementById('warehouse');
  const whStatus  = document.getElementById('wh-status');
  const npRow     = document.getElementById('np-row');
  const commentI  = document.getElementById('comment');

  // Попередньо обраний вид меду з головної
  (function(){
    const t = localStorage.getItem('preselected_type');
    if(!t) return;
    const opt = Array.from(honeySel.options).find(o => o.value === t || o.textContent === t);
    if (opt) honeySel.value = opt.value;
    localStorage.removeItem('preselected_type');
  })();

  // ===== helpers =====
  const setWhStatus = (msg, type='muted') => {
    whStatus.textContent = msg || '';
    whStatus.className = 'note mt-8 ' + (type || 'muted');
  };
  const clearWh = (placeholder) => {
    whSel.innerHTML = '';
    const o = document.createElement('option');
    o.value = '';
    o.textContent = placeholder || '—';
    whSel.appendChild(o);
  };
  async function fetchJSON(url){
    const r = await fetch(url);
    if(!r.ok) throw new Error('HTTP '+r.status);
    return r.json();
  }

  // ===== МІСТА: пошук → наповнюємо select#city (value = Ref) =====
  let cityTimer;
  citySearch.addEventListener('input', () => {
    const q = citySearch.value.trim();
    if (cityTimer) clearTimeout(cityTimer);
    if (q.length < 2) return;

    cityTimer = setTimeout(async () => {
      try {
        const data = await fetchJSON(`${WORKER_BASE}/np/cities?q=${encodeURIComponent(q)}`);
        // очікуємо { ok:true, data:[{Ref, Description,...}], ... }
        if (!data.ok) return;

        citySel.innerHTML = '';
        const def = document.createElement('option');
        def.value = '';
        def.textContent = 'Оберіть місто зі списку…';
        citySel.appendChild(def);

        const arr = data.data || data.items || [];
        arr.forEach(c => {
          const opt = document.createElement('option');
          opt.value = c.Ref; // ВАЖЛИВО: саме Ref
          opt.textContent = c.Description || c.Present || c.name;
          citySel.appendChild(opt);
        });
      } catch(e) {
        // тихо ігноруємо
      }
    }, 250);
  });

  // ===== ВІДДІЛЕННЯ: за cityRef =====
  citySel.addEventListener('change', loadWarehousesForCityRef);

  async function loadWarehousesForCityRef(){
    const cityRef = citySel.value;
    if(!cityRef){
      whSel.disabled = true;
      clearWh('Спочатку оберіть місто');
      setWhStatus('');
      return;
    }

    whSel.disabled = true;
    clearWh('Завантаження…');
    setWhStatus('Завантажуємо відділення…');

    try{
      const data = await fetchJSON(`${WORKER_BASE}/np/warehouses?cityRef=${encodeURIComponent(cityRef)}`);
      // очікуємо { ok:true, data:[{Number, ShortAddress/Description}], ... }
      if(!data.ok) throw new Error('NP error');

      const list = Array.isArray(data.data) ? data.data :
                   Array.isArray(data.items) ? data.items : [];

      if(!list.length){
        clearWh('Відділень не знайдено');
        whSel.disabled = true;
        setWhStatus('Для цього міста немає відділень.', 'warn');
        return;
      }

      list.sort((a,b) => {
        const aPM = /поштомат|postomat/i.test(a.Description || '');
        const bPM = /поштомат|postomat/i.test(b.Description || '');
        if (aPM !== bPM) return aPM ? 1 : -1;
        return (+a.Number || 0) - (+b.Number || 0);
      });

      whSel.innerHTML = '';
      const first = document.createElement('option');
      first.value = '';
      first.textContent = 'Оберіть відділення';
      whSel.appendChild(first);

      list.forEach(w => {
        const o = document.createElement('option');
        const num = w.Number ? `№${w.Number}` : '';
        const addr = w.ShortAddress || w.Description || '';
        o.value = w.Description || addr;
        o.textContent = `${num} — ${addr}`.replace(/^ — /,'');
        whSel.appendChild(o);
      });

      whSel.disabled = false;
      setWhStatus(`${list.length} відділень знайдено.`);
    }catch(e){
      clearWh('Помилка завантаження');
      whSel.disabled = true;
      setWhStatus('Помилка при завантаженні. Спробуйте ще раз.', 'error');
    }
  }

  // ===== Показ/приховання блоку НП за способом доставки =====
  function applyShipVisibility(){
    const needNP = shipSel.value === 'np_branch';
    npRow.classList.toggle('hidden', !needNP);
    citySel.required = needNP;
    whSel.required  = needNP;
    if (!needNP) setWhStatus('');
  }
  shipSel.addEventListener('change', applyShipVisibility);

  // ===== Сабміт → mailto =====
  form.addEventListener('submit', (e) => {
    e.preventDefault();
    if(!form.reportValidity()) return;

    const pay = form.querySelector('input[name="pay"]:checked')?.value || 'cod';
    const rows = [
      `Замовлення з сайту med_ok`,
      `Імʼя: ${nameI.value}`,
      `Телефон: ${phoneI.value}`,
      `Вид меду: ${honeySel.value}`,
      `Кількість: ${qtySel.value} л`,
      `Доставка: ${shipSel.options[shipSel.selectedIndex].text}`,
      (shipSel.value === 'np_branch') ? `Місто (НП): ${citySel.options[citySel.selectedIndex]?.text}` : null,
      (shipSel.value === 'np_branch') ? `Відділення (НП): ${whSel.value}` : null,
      `Оплата: ${pay === 'cod' ? 'Накладений платіж' : 'Повна передоплата'}`,
      commentI.value ? `Коментар: ${commentI.value}` : null
    ].filter(Boolean);

    const subject = encodeURIComponent('Замовлення меду — med_ok');
    const body    = encodeURIComponent(rows.join('\n'));
    window.location.href = `mailto:${ORDER_EMAIL}?subject=${subject}&body=${body}`;
  });

  // ===== Старт =====
  window.addEventListener('DOMContentLoaded', () => {
    applyShipVisibility();
  });
</script>
</body>
</html>
