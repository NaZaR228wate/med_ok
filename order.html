<!doctype html>
<html lang="uk">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Оформлення замовлення — med_ok</title>
  <link rel="stylesheet" href="styles.css?v=5">
  <meta name="description" content="Замовлення натурального меду з пасіки med_ok. Доставка Новою поштою по всій Україні.">
</head>
<body>
<header>
  <div class="container nav">
    <div class="brand">
      <svg viewBox="0 0 64 64" aria-hidden="true" focusable="false">
        <path fill="#f4b400" d="M22 10h20l10 12v20l-10 12H22L12 42V22z"/>
        <path fill="#fff" opacity=".6" d="M26 18h12l6 7v14l-6 7H26l-6-7V25z"/>
      </svg>
      <span>med_ok</span>
    </div>

    <!-- кнопка меню -->
    <button class="menu-toggle" id="menu-toggle" aria-expanded="false" aria-controls="primary-nav">
      <span class="menu-toggle__bar"></span>
      <span class="menu-toggle__bar"></span>
      <span class="menu-toggle__bar"></span>
      <span class="visually-hidden">Відкрити меню</span>
    </button>

    <!-- меню -->
    <nav id="primary-nav" data-open="false" aria-hidden="true">
      <a href="index.html#products">Продукція</a>
      <a href="index.html#about">Про пасіку</a>
      <a href="index.html#why">Чому ми</a>
      <a href="order.html" class="cta">Замовити</a>
    </nav>
  </div>
</header>

<main class="container" style="padding-top:28px">
  <h1>Оформлення замовлення</h1>
  <p>Заповніть форму. Поля з <b>*</b> — обовʼязкові. Після надсилання відкриється поштовий клієнт із заповненим листом.</p>

  <div class="card" style="max-width:820px;margin:auto">
    <form id="order-form">
      <!-- Контакти -->
      <div class="two">
        <div>
          <label for="name">Ім’я <b>*</b></label>
          <input id="name" required placeholder="Ваше ім’я">
        </div>
        <div>
          <label for="phone">Телефон <b>*</b></label>
          <input id="phone" required placeholder="+380…" inputmode="tel">
        </div>
      </div>

      <!-- Товар -->
      <div class="two">
        <div>
          <label for="type">Вид меду</label>
          <select id="type">
            <option>Акація</option>
            <option>Липовий</option>
            <option>Гречаний</option>
            <option>Різнотрав’я</option>
          </select>
        </div>
        <div>
          <label for="qty">Кількість (кг)</label>
          <input id="qty" type="number" min="1" value="1">
        </div>
      </div>

      <!-- Доставка -->
      <div class="two">
        <div>
          <label for="ship">Спосіб доставки</label>
          <select id="ship">
            <option value="np_branch" selected>Нова пошта — відділення</option>
            <option value="np_courier">Нова пошта — кур’єр</option>
            <option value="pickup">Самовивіз</option>
          </select>
        </div>
        <div>
          <label for="pay">Оплата</label>
          <div style="display:flex;gap:12px;align-items:center;padding:10px 0">
            <label><input type="radio" name="pay" value="cod" checked> Накладений платіж</label>
            <label><input type="radio" name="pay" value="prepay"> Повна передоплата</label>
          </div>
        </div>
      </div>

      <!-- Адреса (динамічні блоки для НП) -->
      <div id="np-block">
        <div class="two">
          <div>
            <label for="city">Місто (Нова пошта) <b>*</b></label>
            <input id="city" list="city-list" placeholder="Почніть вводити місто…" autocomplete="off">
            <datalist id="city-list"></datalist>
            <input type="hidden" id="city-ref">
          </div>
          <div id="wh-wrap">
            <label for="warehouse">Відділення (№/адреса) <b>*</b></label>
            <input id="warehouse" list="wh-list" placeholder="Спочатку оберіть місто" autocomplete="off" disabled>
            <datalist id="wh-list"></datalist>
            <input type="hidden" id="wh-ref">
          </div>
        </div>

        <div id="courier-wrap" class="two" style="display:none">
          <div class="col-12" style="grid-column:span 12">
            <label for="addr">Адреса для кур’єра</label>
            <input id="addr" placeholder="Вулиця, будинок, під’їзд/кв. (за потреби)">
          </div>
        </div>
      </div>

      <!-- Коментар -->
      <label for="note">Коментар</label>
      <textarea id="note" rows="3" placeholder="Зручний час дзвінка, деталі замовлення тощо"></textarea>

      <button class="btn" type="submit">Надіслати замовлення</button>
      <div class="note">Якщо обрано «повна передоплата», ми надішлемо посилання/реквізити для оплати.</div>
    </form>
  </div>

  <p style="margin-top:16px"><a href="index.html">← На головну</a></p>
</main>

<footer class="container">© <span id="y"></span> med_ok</footer>

<script>
  // ===== Налаштування =====
  const ORDER_EMAIL = "Veter010709@gmail.com";
  // Твій Cloudflare Worker:
  const WORKER_BASE = "https://medok-proxy.veter010709.workers.dev";

  // Футер рік
  document.getElementById('y').textContent = new Date().getFullYear();

  // ===== Бургер-меню =====
  (function(){
    const toggle = document.getElementById('menu-toggle');
    const nav = document.getElementById('primary-nav');
    const close = ()=>{ nav.dataset.open='false'; toggle.setAttribute('aria-expanded','false'); toggle.classList.remove('is-open'); nav.setAttribute('aria-hidden','true'); };
    const open  = ()=>{ nav.dataset.open='true';  toggle.setAttribute('aria-expanded','true');  toggle.classList.add('is-open');  nav.setAttribute('aria-hidden','false'); };
    if (!toggle || !nav) return;
    close();
    toggle.addEventListener('click', ()=> (nav.dataset.open==='true'?close():open()));
    nav.querySelectorAll('a').forEach(a=>a.addEventListener('click', close));
    document.addEventListener('click', e=>{ if(nav.dataset.open!=='true')return; if(nav.contains(e.target)||toggle.contains(e.target))return; close(); });
    document.addEventListener('keydown', e=>{ if(e.key==='Escape') close(); });
  })();

  // ===== Доставка перемикач =====
  const shipSel = document.getElementById('ship');
  const whWrap = document.getElementById('wh-wrap');
  const courierWrap = document.getElementById('courier-wrap');
  const cityInput = document.getElementById('city');
  const whInput   = document.getElementById('warehouse');
  const addrInput = document.getElementById('addr');

  function applyShipUI(){
    const mode = shipSel.value;
    if (mode === 'np_branch'){
      whWrap.style.display = '';
      courierWrap.style.display = 'none';
      whInput.disabled = false;
      addrInput.value = '';
    } else if (mode === 'np_courier'){
      whWrap.style.display = 'none';
      courierWrap.style.display = '';
      whInput.value = ''; document.getElementById('wh-ref').value = '';
      whInput.disabled = true;
    } else {
      whWrap.style.display = 'none';
      courierWrap.style.display = 'none';
      whInput.value = ''; document.getElementById('wh-ref').value = '';
      whInput.disabled = true;
      addrInput.value = '';
    }
  }
  shipSel.addEventListener('change', applyShipUI);
  applyShipUI();

  // ===== Автопідказка НП (міста/відділення) =====
  const dlCities = document.getElementById('city-list');
  const dlWh     = document.getElementById('wh-list');
  const cityRef  = document.getElementById('city-ref');
  const whRef    = document.getElementById('wh-ref');

  // маленький дебаунсер
  function debounce(fn, ms=300){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }

  // універсальний витягач тексту/ід
  const getName = (x)=> x?.name || x?.Description || x?.Present || x?.description || '';
  const getId   = (x)=> x?.id   || x?.Ref || x?.ref || '';

  async function fetchJSON(url){
    const r = await fetch(url);
    if (!r.ok) throw new Error('network');
    return r.json();
  }

  // Пошук міст
  async function searchCities(q){
    if (!q || q.length < 2) { dlCities.innerHTML=''; return; }
    try{
      const data = await fetchJSON(`${WORKER_BASE}/np/cities?q=${encodeURIComponent(q)}`);
      const items = (data?.data || data?.items || []).slice(0, 30);
      dlCities.innerHTML = items.map(it => {
        const name = getName(it); const id = getId(it);
        return `<option value="${name}" data-id="${id}"></option>`;
      }).join('');
    }catch(e){ /* тихо */ }
  }

  // Пошук відділень
  async function searchWarehouses(cityId, q=''){
    if (!cityId) { dlWh.innerHTML=''; return; }
    try{
      const data = await fetchJSON(`${WORKER_BASE}/np/warehouses?cityRef=${encodeURIComponent(cityId)}&q=${encodeURIComponent(q||'')}`);
      const items = (data?.data || data?.items || []).slice(0, 50);
      dlWh.innerHTML = items.map(it => {
        const name = getName(it); const id = getId(it);
        return `<option value="${name}" data-id="${id}"></option>`;
      }).join('');
    }catch(e){ /* тихо */ }
  }

  // when city typed
  cityInput.addEventListener('input', debounce(async (e)=>{
    const q = e.target.value.trim();
    cityRef.value = '';
    await searchCities(q);
  }, 300));

  // when city chosen (blur/change — шукаємо exact match в option)
  function lockCityIfMatched(){
    const val = cityInput.value.trim();
    if (!val) { cityRef.value=''; return; }
    const opt = Array.from(dlCities.options).find(o => o.value.toLowerCase() === val.toLowerCase());
    if (opt){
      cityRef.value = opt.dataset.id || '';
      // завантажимо відділення для вибраного міста
      whInput.disabled = false;
      searchWarehouses(cityRef.value, '');
    } else {
      cityRef.value = '';
      whInput.value=''; whRef.value=''; dlWh.innerHTML='';
      whInput.disabled = true;
    }
  }
  cityInput.addEventListener('change', lockCityIfMatched);
  cityInput.addEventListener('blur', lockCityIfMatched);

  // відділення: автопідказка
  whInput.addEventListener('input', debounce(async (e)=>{
    const q = e.target.value.trim();
    whRef.value = '';
    if (!cityRef.value) return;
    await searchWarehouses(cityRef.value, q);
  }, 300));
  function lockWhIfMatched(){
    const val = whInput.value.trim();
    if (!val) { whRef.value=''; return; }
    const opt = Array.from(dlWh.options).find(o => o.value.toLowerCase() === val.toLowerCase());
    whRef.value = opt ? (opt.dataset.id || '') : '';
  }
  whInput.addEventListener('change', lockWhIfMatched);
  whInput.addEventListener('blur', lockWhIfMatched);

  // ===== Надсилання (mailto) =====
  document.getElementById('order-form').addEventListener('submit', function(e){
    e.preventDefault();

    // поля
    const name = document.getElementById('name').value.trim();
    const phone = document.getElementById('phone').value.trim();
    const type = document.getElementById('type').value;
    const qty  = document.getElementById('qty').value;
    const ship = document.getElementById('ship').value;
    const note = document.getElementById('note').value.trim();
    const pay  = (document.querySelector('input[name="pay"]:checked')||{}).value || 'cod';

    // прості валідації для НП
    if (ship !== 'pickup'){
      if (!cityRef.value) { alert('Будь ласка, оберіть місто з підказки Нової пошти.'); return; }
      if (ship === 'np_branch' && !whRef.value){ alert('Будь ласка, оберіть відділення з підказки.'); return; }
      if (ship === 'np_courier' && !addrInput.value.trim()){ alert('Вкажіть адресу для кур’єра.'); return; }
    }

    const shipText = ship === 'np_branch' ? 'НП — відділення'
                    : ship === 'np_courier' ? 'НП — кур’єр'
                    : 'Самовивіз';

    const cityText = cityInput.value.trim();
    const whText   = whInput.value.trim();
    const addrText = addrInput.value.trim();
    const payText  = pay === 'prepay' ? 'Повна передоплата' : 'Накладений платіж';

    const subject = encodeURIComponent('Замовлення меду — med_ok');
    const body = encodeURIComponent(
      `Ім’я: ${name}\n` +
      `Телефон: ${phone}\n` +
      `Вид меду: ${type}\n` +
      `Кількість: ${qty} кг\n` +
      `Оплата: ${payText}\n` +
      `Доставка: ${shipText}\n` +
      (cityText ? `Місто (НП): ${cityText}\n` : '') +
      (whText   ? `Відділення (НП): ${whText}\n` : '') +
      (addrText ? `Адреса для кур’єра: ${addrText}\n` : '') +
      (note ? `Коментар: ${note}\n` : ``) +
      `---\nНадіслано з order.html (med_ok)`
    );

    if (pay === 'prepay'){
      alert('Дякуємо! Ми надішлемо посилання/реквізити для повної передоплати після підтвердження замовлення.');
    }

    window.location.href = `mailto:${ORDER_EMAIL}?subject=${subject}&body=${body}`;
  });
</script>
</body>
</html>
