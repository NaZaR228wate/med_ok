<!doctype html>
<html lang="uk">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>–û—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è ‚Äî med_ok</title>
    <link rel="stylesheet" href="styles.css?v=9"/>
</head>
<body>
<a class="visually-hidden" href="#main">–ü–µ—Ä–µ–π—Ç–∏ –¥–æ –∫–æ–Ω—Ç–µ–Ω—Ç—É</a>

<header>
    <div class="container nav">
        <a class="brand" href="index.html" aria-label="–ù–∞ –≥–æ–ª–æ–≤–Ω—É">
            <svg viewBox="0 0 64 64" aria-hidden="true" focusable="false">
                <path fill="#f4b400" d="M22 10h20l10 12v20l-10 12H22L12 42V22z"/>
                <path fill="#fff" opacity=".6" d="M26 18h12l6 7v14l-6 7H26l-6-7V25z"/>
            </svg>
            <span>med_ok</span>
        </a>

        <button class="menu-toggle" id="menu-toggle" aria-expanded="false" aria-controls="primary-nav">
            <span class="menu-toggle__bar"></span>
            <span class="menu-toggle__bar"></span>
            <span class="menu-toggle__bar"></span>
            <span class="visually-hidden">–ú–µ–Ω—é</span>
        </button>

        <nav id="primary-nav" data-open="false" aria-hidden="true">
            <a href="index.html#products">–ü—Ä–æ–¥—É–∫—Ü—ñ—è</a>
            <a href="index.html#about">–ü—Ä–æ –ø–∞—Å—ñ–∫—É</a>
            <a href="index.html#why">–ß–æ–º—É –º–∏</a>
            <a class="cta" href="order.html">–ó–∞–º–æ–≤–∏—Ç–∏</a>
        </nav>
    </div>
</header>

<main id="main" class="container">
    <h1>–û—Ñ–æ—Ä–º–ª–µ–Ω–Ω—è –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</h1>
    <p class="muted">–ó–∞–ø–æ–≤–Ω—ñ—Ç—å —Ñ–æ—Ä–º—É. –ü–æ–ª—è –∑—ñ <strong>*</strong> ‚Äî –æ–±–æ–≤‚Äô—è–∑–∫–æ–≤—ñ. –ü—ñ—Å–ª—è –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è ¬´–ù–∞–¥—ñ—Å–ª–∞—Ç–∏¬ª –≤—ñ–¥–∫—Ä–∏—î—Ç—å—Å—è –ø–æ—à—Ç–æ–≤–∏–π –∫–ª—ñ—î–Ω—Ç —ñ–∑ –∑–∞–ø–æ–≤–Ω–µ–Ω–∏–º –ª–∏—Å—Ç–æ–º.</p>

    <section class="card" style="padding:18px 18px 6px" id="order">
        <form id="orderForm" novalidate>
            <!-- –Ü–º º—è / –¢–µ–ª–µ—Ñ–æ–Ω -->
            <div class="row row-1">
                <div class="col">
                    <label for="name">–Ü–º º—è *</label>
                    <input id="name" name="name" placeholder="–í–∞—à–µ —ñ–º º—è" required />
                </div>
                <div class="col">
                    <label for="phone">–¢–µ–ª–µ—Ñ–æ–Ω *</label>
                    <input id="phone" name="phone" placeholder="+380‚Ä¶" inputmode="tel"
                           maxlength="13" pattern="^\+380\d{9}$" title="+380XXXXXXXXX" required />
                </div>
            </div>

            <!-- –í–∏–¥ –º–µ–¥—É / –ö—ñ–ª—å–∫—ñ—Å—Ç—å -->
            <div class="row mt-16">
                <div class="col">
                    <label for="honey">–í–∏–¥ –º–µ–¥—É *</label>
                    <select id="honey" name="honey" required>
                        <option value="–ê–∫–∞—Ü—ñ—è">–ê–∫–∞—Ü—ñ—è</option>
                        <option value="–õ–∏–ø–æ–≤–∏–π">–õ–∏–ø–æ–≤–∏–π</option>
                        <option value="–°–æ–Ω—è—à–Ω–∏–∫–æ–≤–∏–π">–°–æ–Ω—è—à–Ω–∏–∫–æ–≤–∏–π</option>
                    </select>
                </div>
                <div class="col">
                    <label for="qty">–ö—ñ–ª—å–∫—ñ—Å—Ç—å (–ª) *</label>
                    <select id="qty" name="qty" required>
                        <option value="0.5">0.5 –ª</option>
                        <option value="1">1 –ª</option>
                        <option value="2">2 –ª</option>
                        <option value="3">3 –ª</option>
                        <option value="5">5 –ª</option>
                    </select>
                </div>
            </div>

            <!-- –î–æ—Å—Ç–∞–≤–∫–∞ / –û–ø–ª–∞—Ç–∞ -->
            <div class="row mt-16">
                <div class="col">
                    <label for="ship">–°–ø–æ—Å—ñ–± –¥–æ—Å—Ç–∞–≤–∫–∏ *</label>
                    <select id="ship" name="ship" required>
                        <option value="np_branch" selected>–ù–æ–≤–∞ –ø–æ—à—Ç–∞ ‚Äî –≤—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è</option>
                    </select>
                </div>
                <div class="col">
                    <label>–û–ø–ª–∞—Ç–∞ *</label>
                    <div style="display:flex;gap:16px;align-items:center;padding:10px 0">
                        <label><input type="radio" name="pay" value="cod" checked> –ù–∞–∫–ª–∞–¥–µ–Ω–∏–π –ø–ª–∞—Ç—ñ–∂</label>
                        <label><input type="radio" name="pay" value="prepay"> –ü–æ–≤–Ω–∞ –ø–µ—Ä–µ–¥–æ–ø–ª–∞—Ç–∞</label>
                    </div>
                </div>
            </div>

            <!-- –ù–æ–≤–∞ –ø–æ—à—Ç–∞: –ø–æ—à—É–∫ + –º—ñ—Å—Ç–æ(Ref) + –≤—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è -->
            <div id="np-row" class="row mt-16">
                <div class="col">
                    <label for="citySearch">–ü–æ—à—É–∫ –º—ñ—Å—Ç–∞ (2+ –ª—ñ—Ç–µ—Ä–∏)</label>
                    <input id="citySearch" placeholder="–ü–æ—á–Ω—ñ—Ç—å –≤–≤–æ–¥–∏—Ç–∏ –Ω–∞–∑–≤—É‚Ä¶ (–Ω–∞–ø—Ä., –ö–∏)" autocomplete="off"/>

                    <label for="city" class="mt-8">–ú—ñ—Å—Ç–æ (–ù–æ–≤–∞ –ø–æ—à—Ç–∞) *</label>
                    <select id="city" required>
                        <option value="">–°–ø–æ—á–∞—Ç–∫—É –≤–≤–µ–¥—ñ—Ç—å 2+ –ª—ñ—Ç–µ—Ä–∏ —É –ø–æ–ª—ñ –≤–∏—â–µ‚Ä¶</option>
                    </select>
                </div>
                <div class="col">
                    <label for="warehouse">–í—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è (‚Ññ/–∞–¥—Ä–µ—Å–∞) *</label>
                    <select id="warehouse" disabled required>
                        <option>–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å –º—ñ—Å—Ç–æ</option>
                    </select>
                    <div id="wh-status" class="note mt-8"></div>
                </div>
            </div>

            <!-- –ö–æ–º–µ–Ω—Ç–∞—Ä -->
            <div class="row mt-16">
                <div class="col" style="grid-column:1/-1">
                    <label for="comment">–ö–æ–º–µ–Ω—Ç–∞—Ä</label>
                    <textarea id="comment" name="comment" placeholder="–ó—Ä—É—á–Ω–∏–π —á–∞—Å –¥–∑–≤—ñ–Ω–∫–∞, –¥–µ—Ç–∞–ª—ñ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è —Ç–æ—â–æ"></textarea>
                </div>
            </div>

            <div class="actions mt-16">
                <button type="submit" class="btn">–ù–∞–¥—ñ—Å–ª–∞—Ç–∏</button>
            </div>

            <p class="muted mt-16" style="text-align:center">
                –Ø–∫—â–æ –æ–±—Ä–∞–Ω–æ ¬´–ø–æ–≤–Ω–∞ –ø–µ—Ä–µ–¥–æ–ø–ª–∞—Ç–∞¬ª, –º–∏ –Ω–∞–¥—ñ—à–ª–µ–º–æ —Ä–µ–∫–≤—ñ–∑–∏—Ç–∏ –ø—ñ—Å–ª—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è.
            </p>
        </form>
    </section>

    <p class="mt-16"><a href="index.html">‚Üê –ù–∞ –≥–æ–ª–æ–≤–Ω—É</a></p>
</main>

<script>
    // ===== –ö–û–ù–§–Ü–ì =====
    const WORKER_BASE = 'https://medok-proxy.veter010709.workers.dev';

    // ===== –•–ï–î–ï–† —è–∫ –Ω–∞ index.html =====
    (function(){
        const toggle = document.getElementById('menu-toggle');
        const nav = document.getElementById('primary-nav');
        if (!toggle || !nav) return;
        const close = () => { nav.dataset.open='false'; toggle.setAttribute('aria-expanded','false'); toggle.classList.remove('is-open'); nav.setAttribute('aria-hidden','true'); };
        const open  = () => { nav.dataset.open='true';  toggle.setAttribute('aria-expanded','true');  toggle.classList.add('is-open');  nav.setAttribute('aria-hidden','false'); };
        close();
        toggle.addEventListener('click', () => (nav.dataset.open==='true'?close():open()));
        nav.querySelectorAll('a').forEach(a => a.addEventListener('click', close));
        document.addEventListener('click', (e)=>{ if(nav.dataset.open!=='true')return; if(nav.contains(e.target)||toggle.contains(e.target))return; close(); });
        document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') close(); });
        function syncDesktop(){
            if (window.matchMedia('(min-width: 900px)').matches){
                nav.dataset.open = 'true';
                nav.removeAttribute('aria-hidden');
                toggle && toggle.classList.remove('is-open');
                toggle && toggle.setAttribute('aria-expanded','false');
            }
        }
        syncDesktop();
        window.addEventListener('resize', syncDesktop);
    })();

    // ===== DOM =====
    const form      = document.getElementById('orderForm');
    const nameI     = document.getElementById('name');
    const phoneI    = document.getElementById('phone');
    const honeySel  = document.getElementById('honey');
    const qtySel    = document.getElementById('qty');
    const shipSel   = document.getElementById('ship');
    const citySearch= document.getElementById('citySearch');
    const citySel   = document.getElementById('city');      // value = Ref
    const whSel     = document.getElementById('warehouse');
    const whStatus  = document.getElementById('wh-status');
    const npRow     = document.getElementById('np-row');
    const commentI  = document.getElementById('comment');

    // –ü–æ–ø–µ—Ä–µ–¥–Ω—å–æ –æ–±—Ä–∞–Ω–∏–π –≤–∏–¥ –º–µ–¥—É –∑ –≥–æ–ª–æ–≤–Ω–æ—ó
    (function(){
        const t = localStorage.getItem('preselected_type');
        if(!t) return;
        const opt = Array.from(honeySel.options).find(o => o.value === t || o.textContent === t);
        if (opt) honeySel.value = opt.value;
        localStorage.removeItem('preselected_type');
    })();

    // ===== helpers =====
    const setWhStatus = (msg, type='muted') => {
        whStatus.textContent = msg || '';
        whStatus.className = 'note mt-8 ' + (type || 'muted');
    };
    const clearWh = (placeholder) => {
        whSel.innerHTML = '';
        const o = document.createElement('option');
        o.value = '';
        o.textContent = placeholder || '‚Äî';
        whSel.appendChild(o);
    };
    async function fetchJSON(url, init){
        const r = await fetch(url, init);
        if(!r.ok) throw new Error('HTTP '+r.status+' '+r.statusText);
        return r.json();
    }

    // ===== –ú–Ü–°–¢–ê: –ø–æ—à—É–∫ ‚Üí select#city (value = Ref) =====
    let cityTimer;
    citySearch.addEventListener('input', () => {
        const q = citySearch.value.trim();
        if (cityTimer) clearTimeout(cityTimer);
        if (q.length < 2) return;

        cityTimer = setTimeout(async () => {
            try {
                const data = await fetchJSON(`${WORKER_BASE}/np/cities?q=${encodeURIComponent(q)}`);
                const arr = Array.isArray(data.data) ? data.data : Array.isArray(data.items) ? data.items : [];

                citySel.innerHTML = '';
                const def = document.createElement('option');
                def.value = '';
                def.textContent = '–û–±–µ—Ä—ñ—Ç—å –º—ñ—Å—Ç–æ –∑—ñ —Å–ø–∏—Å–∫—É‚Ä¶';
                citySel.appendChild(def);

                arr.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c.Ref;                       // –≤–∞–∂–ª–∏–≤–æ: Ref
                    opt.textContent = c.Description || c.Present || c.name;
                    citySel.appendChild(opt);
                });
            } catch(e) {
                // —Ç–∏—Ö–æ —ñ–≥–Ω–æ—Ä—É—î–º–æ
            }
        }, 250);
    });

    // ===== –í–Ü–î–î–Ü–õ–ï–ù–ù–Ø: –∑–∞ cityRef =====
    citySel.addEventListener('change', loadWarehousesForCityRef);

    async function loadWarehousesForCityRef(){
        const cityRef = citySel.value;
        if(!cityRef){
            whSel.disabled = true;
            clearWh('–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å –º—ñ—Å—Ç–æ');
            setWhStatus('');
            return;
        }

        whSel.disabled = true;
        clearWh('–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è‚Ä¶');
        setWhStatus('–ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –≤—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è‚Ä¶');

        try{
            const data = await fetchJSON(`${WORKER_BASE}/np/warehouses?cityRef=${encodeURIComponent(cityRef)}`);
            const list = Array.isArray(data.data) ? data.data :
                Array.isArray(data.items) ? data.items : [];

            if(!list.length){
                clearWh('–í—ñ–¥–¥—ñ–ª–µ–Ω—å –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ');
                whSel.disabled = true;
                setWhStatus('–î–ª—è —Ü—å–æ–≥–æ –º—ñ—Å—Ç–∞ –Ω–µ–º–∞—î –≤—ñ–¥–¥—ñ–ª–µ–Ω—å.', 'warn');
                return;
            }

            // –ø–æ—à—Ç–æ–º–∞—Ç–∏ –≤–Ω–∏–∑
            list.sort((a,b) => {
                const aPM = /–ø–æ—à—Ç–æ–º–∞—Ç|postomat/i.test(a.Description || '');
                const bPM = /–ø–æ—à—Ç–æ–º–∞—Ç|postomat/i.test(b.Description || '');
                if (aPM !== bPM) return aPM ? 1 : -1;
                return (+a.Number || 0) - (+b.Number || 0);
            });

            whSel.innerHTML = '';
            const first = document.createElement('option');
            first.value = '';
            first.textContent = '–û–±–µ—Ä—ñ—Ç—å –≤—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è';
            whSel.appendChild(first);

            list.forEach(w => {
                const o = document.createElement('option');
                const num = w.Number ? `‚Ññ${w.Number}` : '';
                const addr = w.ShortAddress || w.Description || '';
                o.value = w.Description || addr;
                o.textContent = `${num} ‚Äî ${addr}`.replace(/^ ‚Äî /,'');
                whSel.appendChild(o);
            });

            whSel.disabled = false;
            setWhStatus(`${list.length} –≤—ñ–¥–¥—ñ–ª–µ–Ω—å –∑–Ω–∞–π–¥–µ–Ω–æ.`);
        }catch(e){
            clearWh('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è');
            whSel.disabled = true;
            setWhStatus('–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.', 'error');
        }
    }

    // –ü–æ–∫–∞–∑/–ø—Ä–∏—Ö–æ–≤–∞–Ω–Ω—è –ù–ü
    function applyShipVisibility(){
        const needNP = shipSel.value === 'np_branch';
        npRow.classList.toggle('hidden', !needNP);
        citySel.required = needNP;
        whSel.required  = needNP;
        if (!needNP) setWhStatus('');
    }
    shipSel.addEventListener('change', applyShipVisibility);

    // ===== –°–∞–±–º—ñ—Ç ‚Üí Cloudflare Worker /order ‚Üí Telegram =====
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const submitBtn = form.querySelector('button[type="submit"]');
        try {
            if(!form.reportValidity()) return;

            const pay = form.querySelector('input[name="pay"]:checked')?.value || 'cod';
            const payload = {
                name: nameI.value.trim(),
                phone: phoneI.value.trim(),
                honey: honeySel.value,
                qty:   qtySel.value,
                pay,
                np_city:      citySel.options[citySel.selectedIndex]?.text || '',
                np_warehouse: whSel.value || '',
                comment:      commentI.value.trim()
            };

            if (shipSel.value === 'np_branch' && (!payload.np_city || !payload.np_warehouse)) {
                alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –æ–±–µ—Ä—ñ—Ç—å –º—ñ—Å—Ç–æ —ñ –≤—ñ–¥–¥—ñ–ª–µ–Ω–Ω—è –ù–æ–≤–æ—ó –ø–æ—à—Ç–∏.');
                return;
            }

            // disable btn
            if (submitBtn){ submitBtn.disabled = true; const t=submitBtn.textContent; submitBtn.dataset._t=t; submitBtn.textContent='–ù–∞–¥—Å–∏–ª–∞—î–º–æ‚Ä¶'; }

            const r = await fetch(`${WORKER_BASE}/order`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            });

            if (!r.ok) {
                const txt = await r.text().catch(()=> '');
                throw new Error(`HTTP ${r.status} ${r.statusText} ${txt}`);
            }
            const data = await r.json().catch(()=> ({}));
            if (!data.ok) throw new Error('Worker –≤—ñ–¥–ø–æ–≤—ñ–≤ ok:false');

            alert('–î—è–∫—É—é! –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram üêù');
            form.reset();
            applyShipVisibility();
            clearWh('–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å –º—ñ—Å—Ç–æ');
            setWhStatus('');
        } catch (err) {
            console.error('Submit error:', err);
            alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.\n' + (err?.message || err));
        } finally {
            if (submitBtn){ submitBtn.disabled = false; submitBtn.textContent = submitBtn.dataset._t || '–ù–∞–¥—ñ—Å–ª–∞—Ç–∏'; }
        }
    });

    // ===== –°—Ç–∞—Ä—Ç =====
    window.addEventListener('DOMContentLoaded', () => {
        applyShipVisibility();
    });
</script>

</body>
</html>
